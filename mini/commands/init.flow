import mini/commands/db;
import mini/forth/init;
import mini/forth/eval;
import mini/types/builtin;

export {
	makeMiniDb(includes : [string], onError : (string) -> void) -> MiniDb;
}

makeMiniDb(includes : [string], onError : (string) -> void) -> MiniDb {
	strict = isUrlParameterTrue("strict");
	options = MiniOptions(
		s2i(getUrlParameter("verbose")), 
		// Implicit type pars
		!strict
	);
	db = MiniDb(
		includes, 
		makeTree(), 
		MiniDependent(makeTree(), makeTree()),
		makeMiniFileCache(),
		MiniAst(makeTree(), makeTree(), makeTree(), makeTree(), MiniDependent(makeTree(), makeTree()), 
			getBuiltinMiniTypes(), makeTree(), makeTree(), MiniSubtypeGraph(makeSimpleGraph()),
			makeTree(), getBuiltinPureNames(), options),
		makeMiniForth(),
		makeTree(),
		makeTree(),
		makeList(),
		onError
	);

	lib = getFileContent("mini/forth/lib.forth");
	miniEvalForths("", db, strSplit(lib, "\n"))
}
