import mini/interpreter/env;
import mini/exp/value;

export {
	evalMiniStaticCall(env : MiniInterpreter, fn : MiniVar, args : [MiniExp], pos : int, tyvar : int) -> MiniExp;
}

evalMiniStaticCall(env : MiniInterpreter, fn : MiniVar, args : [MiniExp], pos : int, tyvar : int) -> MiniExp {
	def = MiniCall(fn, args, pos, tyvar);
	if (fn.name == "+") {
		if (isMiniInt(args[0]) && isMiniInt(args[1])) {
			MiniInt(getMiniInt(args[0]) + getMiniInt(args[1]), pos, tyvar);
		} else if (isMiniDouble(args[0]) && isMiniDouble(args[1])) {
			MiniDouble(getMiniDouble(args[0]) + getMiniDouble(args[1]), pos);
		} else if (isMiniString(args[0]) && isMiniString(args[1])) {
			MiniString(getMiniString(args[0]) + getMiniString(args[1]), pos);
		} else def;
	} else if (fn.name == "-") {
		if (isMiniInt(args[0]) && isMiniInt(args[1])) {
			MiniInt(getMiniInt(args[0]) - getMiniInt(args[1]), pos, tyvar);
		} else if (isMiniDouble(args[0]) && isMiniDouble(args[1])) {
			MiniDouble(getMiniDouble(args[0]) - getMiniDouble(args[1]), pos);
		} else def;
	} else if (fn.name == "*") {
		if (isMiniInt(args[0]) && isMiniInt(args[1])) {
			MiniInt(getMiniInt(args[0]) * getMiniInt(args[1]), pos, tyvar);
		} else if (isMiniDouble(args[0]) && isMiniDouble(args[1])) {
			MiniDouble(getMiniDouble(args[0]) * getMiniDouble(args[1]), pos);
		} else def;
	} else if (fn.name == "/") {
		if (isMiniInt(args[0]) && isMiniInt(args[1])) {
			MiniInt(getMiniInt(args[0]) / getMiniInt(args[1]), pos, tyvar);
		} else if (isMiniDouble(args[0]) && isMiniDouble(args[1])) {
			MiniDouble(getMiniDouble(args[0]) / getMiniDouble(args[1]), pos);
		} else def;
	} else if (fn.name == "%") {
		if (isMiniInt(args[0]) && isMiniInt(args[1])) {
			MiniInt(getMiniInt(args[0]) % getMiniInt(args[1]), pos, tyvar);
		} else if (isMiniDouble(args[0]) && isMiniDouble(args[1])) {
			MiniDouble(getMiniDouble(args[0]) % getMiniDouble(args[1]), pos);
		} else def;
	} else if (fn.name == "==") {
		cmp = compareMiniValue(args[0], args[1]);
		if (cmp == -2) def
		else MiniInt(b2i(cmp == 0), pos, tyvar);
	} else if (fn.name == "!=") {
		cmp = compareMiniValue(args[0], args[1]);
		if (cmp == -2) def
		else MiniInt(b2i(cmp != 0), pos, tyvar);
	} else if (fn.name == "<=") {
		cmp = compareMiniValue(args[0], args[1]);
		if (cmp == -2) def
		else MiniInt(b2i(cmp <= 0), pos, tyvar);
	} else if (fn.name == "<") {
		cmp = compareMiniValue(args[0], args[1]);
		if (cmp == -2) def
		else MiniInt(b2i(cmp < 0), pos, tyvar);
	} else if (fn.name == ">=") {
		cmp = compareMiniValue(args[0], args[1]);
		if (cmp == -2) def
		else MiniInt(b2i(cmp >= 0), pos, tyvar);
	} else if (fn.name == ">") {
		cmp = compareMiniValue(args[0], args[1]);
		if (cmp == -2) def
		else MiniInt(b2i(cmp > 0), pos, tyvar);
	} else if (fn.name == "&&") {
		if (isMiniInt(args[0])) {
			left = getMiniInt(args[0]);
			if (left == 0) {
				// False
				args[0];
			} else {
				args[1];
			}
		} else def
	} else if (fn.name == "||") {
		if (isMiniInt(args[0])) {
			left = getMiniInt(args[0]);
			if (left != 0) {
				// True
				args[0];
			} else {
				args[1];
			}
		} else def
	} else {
		println("TODO: Implement " + fn.name);
		def
	}
}

compareMiniValue(left : MiniExp, right : MiniExp) -> int {
	switch (left) {
		MiniInt(lvalue, pos, tyvar): switch (right) {
			MiniInt(rvalue, __, __): genericCompare(lvalue, rvalue);
			default: -2;
		}
		MiniDouble(lvalue, pos): switch (right) {
			MiniDouble(rvalue, __): genericCompare(lvalue, rvalue);
			default: -2;
		}
		MiniString(lvalue, pos):  switch (right) {
			MiniString(rvalue, __): genericCompare(lvalue, rvalue);
			default: -2;
		}
		MiniVar(name, pos, tyvar): -2;
		MiniLet(name, value, body, pos, tyvar): -2;
		MiniLambda(args, body, pos, tyvar): -2;
		MiniCall(fn, args, pos, tyvar): -2;
	}
}
