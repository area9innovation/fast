import mini/forth/forth;
import mini/forth/stack;
import mini/exp/value;

import gringo/gringo_lib;

export {
	prepareGringoParser(actions : GringoAction<MiniDb>, grammar : string) -> (MiniDb) -> MiniDb;
}

prepareGringoParser(actions : GringoAction<MiniDb>, grammar : string) -> (MiniDb) -> MiniDb {
	gterm = parseGringoGrammar(grammar);

	// println("The grammar we will parse:");
	// println(gterm2string(gterm));

	\db : MiniDb -> {
		text = popMiniValue(db);
		// Here, we should parse the grammar using Forth actions
		env = GringoEnv(getMiniString(text.first), makeTree(), 0, actions, text.second, false, false, makeTree());
		genv : GringoEnv<MiniDb> = gringoParse(env, gterm);

		if (!isEmptyTree(genv.errors)) {

			println("There are " + i2s(sizeTree(genv.errors)) + " syntax errors at " + headList(db.fileStack, ""));
		}
		if (genv.fail) {
			println("Parsing failed");
		} else {
			// println("Parse success");
		}
		remaining = strRight(env.input, genv.i);
		if (remaining != "") {
			db.onError("Did not parse: " + remaining);
		}

		genv.output;
	}
}
