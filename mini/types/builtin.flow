import ds/tree;
import mini/types/type2;

export {
	// Some common types
	miniTypeVoid : MiniType2;
	miniTypeBool : MiniType2;
	miniTypeInt : MiniType2;
	miniTypeDouble : MiniType2;
	miniTypeString : MiniType2;

	getBuiltinMiniTypes() -> Tree<string, MiniType2>;
}

miniTypeVoid : MiniType2 = MiniType2Int(0);
miniTypeBool : MiniType2 = MiniType2Call("bool", []);
miniTypeInt : MiniType2 = MiniType2Int(32);
miniTypeDouble : MiniType2 = MiniType2Call("double", []);
miniTypeString : MiniType2 = MiniType2Call("string", []);

getBuiltinMiniTypes() -> Tree<string, MiniType2> {

	v = miniTypeVoid;
	b = miniTypeBool;
	i = MiniType2Int(32);
	s = miniTypeString;

	at = \t -> MiniType2Call("array", [t]);
	reftype = \t -> MiniType2Call("ref", [t]);

	ta = MiniType2Par("?");
	tb = MiniType2Par("??");

	pairs2tree([
		Pair("__ifte", MiniType2Function([b, ta, ta], ta)),
		Pair("__ift", MiniType2Function([b, v, v], v)),

		Pair(";", MiniType2Function([ta, tb], tb)),

		Pair("||", MiniType2Function([b, b], b)),
		Pair("&&", MiniType2Function([b, b], b)),

		Pair("==", MiniType2Function([ta, ta], b)),
		Pair("!=", MiniType2Function([ta, ta], b)),
		Pair("<=", MiniType2Function([ta, ta], b)),
		Pair("<", MiniType2Function([ta, ta], b)),
		Pair(">=", MiniType2Function([ta, ta], b)),
		Pair(">", MiniType2Function([ta, ta], b)),

		Pair("+", MiniType2Function([ta, ta], ta)),
		Pair("-", MiniType2Function([ta, ta], ta)),

		Pair("*", MiniType2Function([ta, ta], ta)),
		Pair("/", MiniType2Function([ta, ta], ta)),
		Pair("%", MiniType2Function([ta, ta], ta)),

		Pair("__not", MiniType2Function([b], b)),
		Pair("__neg", MiniType2Function([ta], ta)),

		Pair(".", MiniType2Function([ta, s], tb)),

		Pair("__index", MiniType2Function([at(ta), i], ta)),

		// : is special and should probably be grabbed by the type inference?

		// TODO: This is not unary, so we have to figure something out here
		Pair("[", MiniType2Function([ta], at(ta))),

	//__switch __case __pattern  __default  __native  __struct __structarg  __with  __mutassign   __fieldassign
	// :

		Pair("__cast", MiniType2Function([ta, ta, tb], tb)),

		Pair("__ref", MiniType2Function([ta], reftype(ta))),
		Pair("__deref", MiniType2Function([reftype(ta)], ta)),

		Pair("__void", MiniType2Function([], v)),

		Pair("__native", MiniType2Function([i, ta, s], ta)),

		// __void
	])
}

