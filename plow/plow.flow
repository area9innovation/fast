import plow/backends/js;
import plow/pexp/parse;
import plow/pexp/pretty;
import plow/dexp/desugar;
import plow/dexp/pretty;
import plow/driver;
import fs/filesystem;
import math/stringmath;

main() {
	file0 = "plow/plow.flow";
	file6 = "plow/tests/";
	file = "plow/tests/assign.flow";
	file4  = "plow/tests/maybe.flow";
	file3  = "behaviour.flow";
	file1 = "c:/flow9/lib/formats/unicode/unidecode.flow";
	file2 = "c:\\lyceum/components/rhapsode_server/rhapsode_server/api/isams/import_data.flow";
	file5 = "mini/tests";

	includes = strSplit(getUrlParameter("I"), ",");
	allincludes = filter(concat([".", getFlowDir() + "/lib", getFlowDir()], includes), neq(""));

	errors = ref 0;
	t = timestamp();

	thefile = getUrlParameterDef("file", file);

	if (!isDirectory(thefile)) {
		cache = makePlowCache(\e -> {
			errors := ^errors + 1;
			println(e);
		}, allincludes);

		b = compilePlow(cache, thefile);
		if (isUrlParameterTrue("js")) {
			println("building JS target");
			js = bmodule2js(cache, b.flowpath);
			setFileContent(changeFileExt(thefile, ".js"), js);
			{}
		}
	} else {
		files = filter(readDirectoryRecursively(thefile), \f -> endsWith(f, ".flow"));

		iter(files, \fil -> {
			// println(fil);
			if (^errors < 1000) {
				println("\n" + fil);
				cache = makePlowCache(\e -> {
					errors := ^errors + 1;
					println(e);
				}, allincludes);

				b = compilePlow(cache, fil);
				if (isUrlParameterTrue("js")) {
					js = bmodule2js(cache, b.flowpath);
					setFileContent(changeFileExt(thefile, ".js"), js);
					{}
				}
			}
		});	
	};

	println(d2st((timestamp() - t) / 1000.0, 2) + "s");

	quit(0);
}
