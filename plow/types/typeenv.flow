import ds/tree;
import plow/types/type;
import ds/egraph;

export {
	TTypeEnv(
		// Map from type par to tyvar
		typars : Tree<string, int>,
		// Construct a new type var
		mkTyvar : () -> int,
		// Report an error associated with a given tyvar
		onError : (tyvar : int, error : string) -> void,

		// Get the type of an id
		resolveId : (string) -> TType,

		// The types of local ids so far
		localTypes : Tree<string, TType>,

		// The egraph with the type equivalent classes
		egraph : EGraph<TType>,

		// When we start to extract equivalence classes
		etypes : ref Tree<int, TType>,
		// When we start to extract types
		tyvars : ref Tree<int, TType>,
	);

	makeTTypeEnv() -> TTypeEnv;
}

makeTTypeEnv() -> TTypeEnv {
	TTypeEnv(
		makeTree(), \ -> 0, 
		\tv, error -> println(error), 
		\id -> {
			println("TODO: Find the type of " + id);
			TTypeName("ERROR", [])
		},
		makeTree(), makeEGraph(splitTType), ref makeTree(), ref makeTree()
	);
}

splitTType(t : TType) -> Pair<TType, [TType]> {
	switch (t) {
		TTypeName(id, typars): Pair(TTypeName(id, []), typars);
		TTypeVar(id): Pair(t, []);
		TTypeFunction(args, returnType): {
			Pair(
				// Make sure we keep the arity
				TTypeFunction(map(args, \__ -> TTypeName("", [])), TTypeName("", [])), 
				arrayPush(args, returnType)
			);
		}
	}
}
